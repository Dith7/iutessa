{% extends 'administration/base.html' %}

{% block title %}Gestion des Étudiants{% endblock %}

{% block breadcrumb_items %}
<li><i class="fas fa-chevron-right text-gray-400 mx-2"></i></li>
<li class="text-gray-500">Académique</li>
<li><i class="fas fa-chevron-right text-gray-400 mx-2"></i></li>
<li class="text-gray-500">Étudiants</li>
{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-4xl font-bold text-gradient-iut mb-2">Gestion des Étudiants</h1>
    <p class="text-lg text-gray-600">Administration des dossiers académiques</p>
</div>

<!-- Statistiques -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white/90 backdrop-blur-xl rounded-3xl p-6 shadow-xl border border-green-100">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-iut rounded-xl flex items-center justify-center shadow-lg">
                <i class="fas fa-users text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Total</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white/90 backdrop-blur-xl rounded-3xl p-6 shadow-xl border border-green-100">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-clock text-yellow-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">En attente</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.en_attente }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white/90 backdrop-blur-xl rounded-3xl p-6 shadow-xl border border-green-100">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Validés</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.valides }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white/90 backdrop-blur-xl rounded-3xl p-6 shadow-xl border border-green-100">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-times-circle text-red-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Rejetés</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.rejetes }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtres et actions -->
<div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl border border-green-100 p-6 mb-8">
    <form method="get" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                {{ form.filiere.label_tag }}
                {{ form.filiere }}
            </div>
            <div>
                {{ form.statut_inscription.label_tag }}
                {{ form.statut_inscription }}
            </div>
            <div>
                {{ form.statut_validation.label_tag }}
                {{ form.statut_validation }}
            </div>
            <div>
                {{ form.recherche.label_tag }}
                {{ form.recherche }}
            </div>
        </div>
        <div class="flex justify-between items-center">
            <button type="submit" class="btn-gradient text-white px-6 py-2 rounded-lg font-medium">
                <i class="fas fa-search mr-2"></i>Filtrer
            </button>
            <div class="flex space-x-3">
                <a href="{% url 'academique:admin_import_etudiants' %}" 
                   class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-smooth font-medium">
                    <i class="fas fa-upload mr-2"></i>Import Excel
                </a>
                <a href="{% url 'academique:export_etudiants_excel' %}" 
                   class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-smooth font-medium">
                    <i class="fas fa-download mr-2"></i>Export
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Liste des étudiants -->
<div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl border border-green-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-green-100">
            <thead class="bg-gradient-soft">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Étudiant
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Filière
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Contact
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Inscription
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Validation
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Documents
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white/50 divide-y divide-green-100">
                {% for etudiant in etudiants %}
                <tr class="hover:bg-gradient-soft transition-smooth">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-iut rounded-full flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-white font-bold text-sm">{{ etudiant.nom|first }}{{ etudiant.prenoms|first }}</span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-900">{{ etudiant.nom_complet }}</p>
                                <p class="text-sm text-gray-600">{{ etudiant.numero_matricule }}</p>
                                <p class="text-xs text-gray-500">CNI: {{ etudiant.cni }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            {{ etudiant.filiere.code }}
                        </span>
                        <p class="text-sm text-gray-600 mt-1">{{ etudiant.filiere.nom }}</p>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <p class="text-sm text-gray-900">{{ etudiant.telephone }}</p>
                        <p class="text-sm text-gray-600">{{ etudiant.email_personnel }}</p>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if etudiant.statut_inscription == 'confirme' %}bg-green-100 text-green-800
                            {% elif etudiant.statut_inscription == 'en_attente' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ etudiant.get_statut_inscription_display }}
                        </span>
                        <p class="text-xs text-gray-500 mt-1">{{ etudiant.date_inscription|date:"d/m/Y" }}</p>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if etudiant.statut_validation == 'valide' %}bg-green-100 text-green-800
                            {% elif etudiant.statut_validation == 'en_attente' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ etudiant.get_statut_validation_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% with docs_count=etudiant.documents.count docs_valides=etudiant.documents_valides_count %}
                        <div class="flex items-center justify-center">
                            <div class="w-8 h-8 rounded-full border-2 
                                {% if docs_valides == docs_count and docs_count > 0 %}border-green-500 text-green-600
                                {% elif docs_valides > 0 %}border-yellow-500 text-yellow-600
                                {% else %}border-red-500 text-red-600{% endif %} 
                                flex items-center justify-center">
                                <span class="text-xs font-bold">{{ docs_valides|default:0 }}/{{ docs_count }}</span>
                            </div>
                        </div>
                        {% endwith %}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <!-- Bouton Voir détails -->
                            <a href="{% url 'academique:admin_etudiant_detail' etudiant.id %}" 
                               class="text-green-600 hover:text-green-800 transition-smooth p-1 rounded hover:bg-green-50" 
                               title="Voir détails">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            {% if etudiant.statut_validation == 'en_attente' %}
                            <!-- Bouton Valider -->
                            <form method="post" action="{% url 'academique:admin_validate_inscription' etudiant.id %}" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="valider">
                                <button type="submit" 
                                        class="text-blue-600 hover:text-blue-800 transition-smooth p-1 rounded hover:bg-blue-50" 
                                        title="Valider inscription"
                                        onclick="return confirm('Confirmer la validation de l\'inscription de {{ etudiant.nom_complet|escapejs }} ?')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                            
                            <!-- Bouton Rejeter -->
                            <button onclick="openRejectModal({{ etudiant.id }}, '{{ etudiant.nom_complet|escapejs }}')" 
                                    class="text-red-600 hover:text-red-800 transition-smooth p-1 rounded hover:bg-red-50" 
                                    title="Rejeter inscription">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <div class="text-gray-500">
                            <i class="fas fa-user-graduate text-4xl mb-4"></i>
                            <p class="text-lg font-medium">Aucun étudiant trouvé</p>
                            <p class="text-sm">Les étudiants apparaîtront ici après inscription</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if etudiants.has_other_pages %}
    <div class="bg-gradient-soft px-4 py-3 border-t border-green-100 sm:px-6">
        <div class="flex items-center justify-between">
            <p class="text-sm text-gray-700">
                Affichage de {{ etudiants.start_index }} à {{ etudiants.end_index }} sur {{ etudiants.paginator.count }} résultats
            </p>
            <nav class="relative z-0 inline-flex rounded-lg shadow-sm -space-x-px">
                {% if etudiants.has_previous %}
                <a href="?page={{ etudiants.previous_page_number }}&{{ request.GET.urlencode }}" 
                   class="relative inline-flex items-center px-2 py-2 rounded-l-lg border border-green-200 bg-white/70 text-sm font-medium text-gray-500 hover:bg-white transition-smooth">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}
                
                <span class="relative inline-flex items-center px-4 py-2 border border-green-200 bg-green-100 text-sm font-medium text-green-700">
                    {{ etudiants.number }}
                </span>
                
                {% if etudiants.has_next %}
                <a href="?page={{ etudiants.next_page_number }}&{{ request.GET.urlencode }}" 
                   class="relative inline-flex items-center px-2 py-2 rounded-r-lg border border-green-200 bg-white/70 text-sm font-medium text-gray-500 hover:bg-white transition-smooth">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de rejet -->
<div id="rejectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20">
        <div class="bg-white rounded-3xl max-w-md w-full p-6 shadow-2xl border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center mr-3">
                    <i class="fas fa-times text-red-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Rejeter l'inscription</h3>
            </div>
            
            <p class="text-gray-600 mb-4">
                Vous êtes sur le point de rejeter l'inscription de <span id="etudiantNom" class="font-semibold"></span>.
            </p>
            
            <form id="rejectForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="rejeter">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Raison du rejet <span class="text-red-500">*</span>
                    </label>
                    <textarea name="raison" 
                              id="raisonRejet"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" 
                              rows="4" 
                              placeholder="Expliquez clairement la raison du rejet pour que l'étudiant puisse corriger..."
                              required></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" 
                            onclick="closeRejectModal()" 
                            class="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-smooth">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-smooth">
                        <i class="fas fa-times mr-2"></i>Rejeter l'inscription
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openRejectModal(etudiantId, etudiantNom) {
    // Mettre à jour l'action du formulaire
    document.getElementById('rejectForm').action = `{% url 'academique:admin_validate_inscription' 0 %}`.replace('0', etudiantId);
    
    // Mettre à jour le nom de l'étudiant dans le modal
    document.getElementById('etudiantNom').textContent = etudiantNom;
    
    // Vider le textarea
    document.getElementById('raisonRejet').value = '';
    
    // Afficher le modal
    document.getElementById('rejectModal').classList.remove('hidden');
    
    // Focus sur le textarea
    setTimeout(() => {
        document.getElementById('raisonRejet').focus();
    }, 100);
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

// Fermer le modal en cliquant à l'extérieur
document.getElementById('rejectModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeRejectModal();
    }
});

// Fermer le modal avec la touche Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRejectModal();
    }
});

// Confirmation avant validation
document.querySelectorAll('form[action*="valider"]').forEach(form => {
    form.addEventListener('submit', function(e) {
        const etudiantNom = this.closest('tr').querySelector('.font-semibold').textContent;
        if (!confirm(`Êtes-vous sûr de vouloir valider l'inscription de ${etudiantNom} ?\n\nCette action enverra une notification à l'étudiant.`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}